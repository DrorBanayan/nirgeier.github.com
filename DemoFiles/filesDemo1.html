<!--
    http://stackoverflow.com/questions/7700273/play-mp3-file-after-uploading-it-with-html5-drag-and-drop-upload
    http://jsfiddle.net/gaJyT/18/
-->
<html>
<head>
    <title>Reading IDV3 info from MP3 file</title>
    <meta charset="utf-8">
    <script src="../js/jdataview.js"></script>
</head>
<style>
    body {
        font-family: Consolas;
        font-size: 36px;
        width: 960px;
        margin: 0 auto;
    }

    fieldset {
        border: 1px solid black;
        border-radius: 5px;
        padding: 5px;
    }

    .infoTitle {
        width: 200px;
        font-weight: bold;
        color: #000000;
        display: inline-block;
        text-transform: capitalize;
    }

    .info {
        color: #000000;
    }

</style>

<body>
<div class="pageWrap">
    <p>
        <a href="http://download.mp3tag.de/mp3tagv249setup.exe">download external mp3tag editor</a>
    </p>

    <fieldset id="drop_zone">
        <legend>Drop MP3 file here</legend>
        <br/>
    </fieldset>

    <br>
    <fieldset>
        <legend>IDV3 info:</legend>
        <output id="info"> -- Load file --</output>
    </fieldset>

    <script>

        FileAPIDemo1 = function() {

            function displayInfo(info) {

                var output, field;
                output = document.querySelector('#info');
                output.innerHTML = '';

                // Not optimized only for the demo :-)
                for (field in info) {
                    output.innerHTML += '<div class="infoTitle">' + field + '</div>:' + info[field] + '<br/>';
                }
            }

            return{
                readTagInfo : function(e) {

                    console.log(e);
                    // FILEAPI FileReader.
                    var reader = new FileReader();

                    // register error handler
                    reader.onerror = function(e) {
                        document.querySelector('#info').innerHTML = JSON.stringify(e);
                    }

                    /**
                     * This method is called once the reader is loading data
                     * @param event
                     */
                    reader.onload = function(e) {

                        var dataView, startIndex, idv3Info = {}, output;

                        // Get the array of bytes (the content of the song)
                        dataView = new jDataView(this.result);

                        // "TAG" starts at byte -128 from EOF.
                        startIndex = dataView.length - 128;

                        // Check to see if this song has id3 tag or not
                        // if the value is ID3 its ID3v2 :-)
                        if (dataView.getString(3, 0) === 'ID3' && dataView.getString(3, startIndex) === 'TAG') {

                            // See http://en.wikipedia.org/wiki/ID3
                            idv3Info.title = dataView.getString(30, dataView.tell()).replace(/\0/g, '');
                            idv3Info.artist = dataView.getString(30, dataView.tell()).replace(/\0/g, '');
                            idv3Info.album = dataView.getString(30, dataView.tell()).replace(/\0/g, '');
                            idv3Info.year = dataView.getString(4, dataView.tell()).replace(/\0/g, '');
                            displayInfo(idv3Info);
                        } else {
                            // no ID3v1 data found.
                        }
                    };
                    console.log(e.dataTransfer.files[0]);
                    reader.readAsArrayBuffer(e.dataTransfer.files[0]);
                }
            };
        }();

        // Setup the dnd listeners.
        var dropZone = document.querySelector('#drop_zone');
        dropZone.addEventListener('dragover', function(evt) {
            evt.stopPropagation();
            evt.preventDefault();
        }, false);
        dropZone.addEventListener('drop', FileAPIDemo1.readTagInfo, false);
    </script>
</div>
</body>
</html>
