<!doctype html>
<html lang="en">
<!--
    http://www.google.co.il/search?gcx=c&sourceid=chrome&ie=UTF-8&q=jsfillde+workers
    https://github.com/rwldrn/jquery-hive
    http://blogs.msdn.com/b/davrous/archive/2011/07/15/introduction-to-the-html5-web-workers-the-javascript-multithreading-approach.aspx
    http://david.blob.core.windows.net/html5/HelloWebWorkers_EN.htm
    http://www.html5rocks.com/en/tutorials/workers/basics/
    http://slides.html5rocks.com/#web-workers
    http://weblog.bocoup.com/javascript-web-workers-from-basics-to-jquery-hive-part-i
    http://www.whatwg.org/specs/web-apps/current-work/multipage/workers.html
    http://www.sitepoint.com/javascript-shared-web-workers-html5/
-->

<head>
    <meta charset="utf-8">
    <title>WebWorkers, FileAPI</title>
    <!--link href='http://fonts.googleapis.com/css?family=Crimson+Text:regular,600,bold' rel='stylesheet' type='text/css'-->
    <link rel="stylesheet" href="style/main.css">
    <link href="style/syntaxHighlighter.css" rel="stylesheet" type="text/css"/>
    <script src="js/syntaxHighlighter.js" type="text/javascript"></script>
</head>

<body>

<div class="toc">
    <div class="current"></div>
    /
    <div class="total"></div>
</div>

<!-- Any section element inside of this container is displayed as a slide -->
<div id="main">
<section>
    <div class="relative">
        <h2 class="workers color1">WebWorkers</h2>
        <ol class="workers color1">
            <li>Dedicated Workers</li>
            <li>Inline Workers</li>
            <li>Shared Workers</li>
        </ol>
        <br/>

        <h2 class="files color2">FileAPI</h2>
        <ol class="files color2">
            <li>File API (Local)</li>
            <li>File System API</li>
        </ol>
        <span class="credit"><a href="mailto:nirgeier@gmail.com">Nir Geier</a> - HTML5Fest 25.10.2011</span>
    </div>

</section>

<section>
    <div class="content">
        <h3 class="color1">HTML4 (Current)</h3>
        <br/>
        <ul data-list="buildUpList">
            <li>No threads (single thread, sequence)</li>
            <li>Workarounds : asynchronously code.</li>
            <ul class="innerList">
                <li><span class="highlight">ajax</span> (XHR/XHR2)/ jsonp</li>
                <li><span class="highlight">events</span></li>
                <li class="strike">setInteval</span> (Not recommended, Bad coding !!!)</li>
                <li><span class="highlight">setTimeout</span></li>
            </ul>
        </ul>
    </div>
    <h1 class="watermarkedHidden">
        Web Workers
        <img class="img" src="images/workers.gif">
    </h1>
</section>

<section>
    <h3 class="color1">Workers</h3>
    <ul data-list="buildUpList">
        <li>Workers code is written in a <span class="highlight">**separate</span> JS file.</li>
        <li>Workers operate <span class="highlight">independently</span> of the browser UI thread.</li>
        <li>Workers run <span class="highlight">non-blocking scripts parallel</span> to the main thread.</li>
        <li>When creating worker - new thread is created and source is downloaded
            <span class="highlight">asynchronously</span>.
            If source not found -> 404 (silent failure)
        </li>
        <li>Workers can only pass data in and out of a thread through the
            <span class="highlight">postMessage()</span> API and
            <span class="highlight">onMessage</span> Event.
        </li>

        <span class="notes">
            <ul>
                <li>The Workers API is originally based on the now deprecated Gears WorkerPool API</li>
                <li>Workers are not intended to be used in large numbers.
                    too many workers will cause a loss of response in the main window.
                </li>
            </ul>

        </span>

    </ul>
</section>

<section>
    <h3 class="color1">Workers Environment (1)</h3>

    <p class="dark">Worker can use any of the following:</p>

    <ul class="moreItems" data-list="buildUpList">
        <li>The <span class="highlight">navigator</span> object</li>
        <li>The <span class="highlight">location</span> object (read-only)</li>
        <li><span class="highlight">XMLHttpRequest</span> (XHR/XHR2)</li>
        <li><span class="highlight">setTimeout()/clearTimeout()</span></li>
        <li><span class="highlight strike">setInterval()/clearInterval()</span></li>
        <li>The <span class="highlight">Application Cache</span></li>
        <li><span class="highlight">importScripts()</span> (load external scripts to worker env)</li>
    </ul>
</section>

<section>
    <h3 class="color1">Workers Environment (2)</h3>

    <p class="dark">Workers don't have access to the following:</p>
    <ul data-list="buildUpList">
        <li>The <span class="highlight"><b>DOM</b></span></li>
        <li>The <span class="highlight">window</span> object
            (No access to variables or functions on main page)
        </li>
        <li>The <span class="highlight">document</span> object</li>
        <li>The <span class="highlight">parent</span> object</li>
        <li class="color1">Workers can only pass data in and out of a thread through the
            <span class="highlight">postMessage()</span> API and
            <span class="highlight">onMessage</span> Event.
        </li>

    </ul>
</section>

<section>
    <h3 class="color1">Worker Code (Main Window)</h3>

        <pre class="brush: javascript; highlight: [21,24]">
        function initWorker(){

            // Creating the worker
            var worker = new Worker( 'path_to_worker_file' );

            // Communicating With a Dedicated Web Worker several alternative to "register" the onmessage
            worker.onmessage = function( e ) { ... };

            // same as above: using DOM2 events (addEventListener)
            worker.addEventListener('message', function(e) { ... }, false);

            // The handler event is passed an object with 3 properties:
            //     filename: the name of the script which caused the error;
            //     lineno  : the line number where the error occurred; and
            //     message : a description of the error.
            worker.onerror = function(e) {
                console.log("Error: ", e.filename, e.lineno, e.message);
            };

            // Starting the worker by sending a first message
            worker.postMessage("html5Fest");

            // In some browser JSON is supported as well
            worker.postMessage( { msg : 'html5Fest', action : 'start'});

            // "killing" the worker
            worker.terminate();
            }
        </pre>

</section>

<section>
    <h3 class="color1">Worker Code (Worker file)</h3>

            <pre class="brush: javascript;">
            // In the worker filewe need to implement the onmessage function

            // Web Workers can also communicate between each others using Message channels.
            // http://www.w3.org/TR/webmessaging/#messagechannel
                
            // this, self are both references to the worker global scope
            // onmessage == self.onmessage == this.onmessage

            self.onmessage = function(e) {
                switch(e.data){
                case "start":
                    run(); // here we will have postMessage(...)
                    break;

                case "stop":
                    // 1 – from the main calling page by calling the terminate()
                    // 2 – from the worker itself via the close()
                    self.close();
                    break;

                default:
                  ...
                  break;
                }
            };
            </pre>

</section>

<section>
    <h3 class="centered"> Demo: Dedicated Web Worker</h3>
</section>

<section>
    <br/>

    <h3 class="color1">Inline Workers</h3>
    <ul data-list="buildUpList">
        <li>Create your worker script on the <span class="highlight">fly</span>, or create a self-contained page
            <span class="highlight">without</span> having to create <span class="highlight">**separate</span> worker
            file.
        </li>
        <li>
            <span class="highlight">"Inline"</span> your worker in the same HTML file as your main logic by<br/>
            creating a <span class="highlight">BlobBuilder</span> and appending the worker code as a string.
        </li>
        <li>
            This is done using <span class="highlight">Blob URL</span>. Blob URLs are unique and last until the document
            is unloaded.
            In Chrome, there's a nice page to view all of the created blob URLs:
            <a target="_blank" href="chrome://blob-internals/">chrome://blob-internals</a>
        </li>
    </ul>
</section>

<section>
    <h3 class="color1">Inline Workers (Code #1)</h3>
    <pre class="brush: html;highlight: [2,3]; ruler: true;">
        ...
        <!-- This is the "hack". set the type to text or any unhandled type and the page will not handle it as javascript -->
        &lt;script id=&quot;worker1&quot; type=&quot;text/plain&quot;&gt;
            onmessage = function(e) { ... };
        &lt;/script&gt;
        </pre>
        <pre class="brush: javascript;first-line: 6; highlight: [10,11,15];">
            ...
            // BlobBuilder Prefix based upon browser: WebKitBlobBuilder || MozBlobBuilder
            var blobBuilder = new /*WebKit*/BlobBuilder();

            // "Grab" the code we defined in lines 4-5 (as text) and set it as the worker code by appending it to the blob
            blobBuilder.append(document.querySelector('#worker1').textContent);

            // The next method creates a simple URL string which can be used to reference data stored in a DOM File or Blob object.
            // Obtain a blob URL reference to our worker 'file'. [Note: window.webkitURL.createObjectURL() in Chrome]
            var worker = new Worker( window.URL.createObjectURL(blobBuilder.getBlob()) );

            worker.onmessage = function(e) { ... };

            worker.postMessage();

            // when not needed nay more: [Chrome: webkitURL.revokeObjectURL()]
            window.URL.revokeObjectURL(blobURL);
            ...
        </pre>

</section>
<section>
    <h3 class="color1">Inline Workers (Code #2)</h3>
        <pre class="brush: javascript;highlight: [4,5,6,13];">

            // Chrome: window.WebKitBlobBuilder, FF: window.MozBlobBuilder
            var blobBuilder = new BlobBuilder();

            // Same as prevoius example but this time simply define the code as inline text
            // blobBuilder.append(document.querySelector('#worker1').textContent);
            blobBuilder.append("onmessage = function(e) { postMessage( 'msg1' ); }");

            // The next method creates a simple URL string which can be used to
            // reference data stored in a DOM File or Blob object.

            // Obtain a blob URL reference to our worker 'file'.
            // Note: window.webkitURL.createObjectURL() in Chrome
            var blobURL = window.URL.createObjectURL(blobBuilder.getBlob());

            var worker = new Worker(blobURL);

            worker.onmessage = function(e) {
              // e.data == 'msg1'
            };

            // Start the worker.
            worker.postMessage();

            // when not needed nay more:
            // Chrome: window.webkitURL.revokeObjectURL()
            window.URL.revokeObjectURL(blobURL);

        </pre>
</section>

<section>
    <h3 class="centered">
        <a href="DemoFiles/workers_inline.html" target="_blank">Demo: Inline Web Worker</a>
    </h3>

</section>

<section>
    <h3 class="color1">Shared Web Worker</h3>

    <ul data-list="buildUpList">
        <li>
            Shared workers, once created <span class="highlight">any script</span> running in the same origin can obtain
            a reference to that worker and communicate with it.
        </li>
        <li>
            Unlike Dedicated web workers, SharedWorkers communicate via a
            <span class="highlight">port</span> object and attach a message event handler. <br/>
        </li>
        <li>
            Before using the first <span class="highlight">postMessage()</span>
            you must call the port’s <span class="highlight">start()</span>.
        </li>
        <li>

        <span class="important">
            Unlike dedicated worker shared worker will live until <span class="highlight">port.close()</span>
            will be called, so its important to "release" them
        </span>

        </li>
    </ul>
</section>

<section>
    <h3>Shared Web Worker (Main page)</h3>
    <pre class="brush: javascript; highlight: [10,13]">
        // Creating a Shared Web Worker
        var worker = new SharedWorker(...);

        // In shared worker the communication is through port
        worker.port.addEventListener("message", function(e) {
            alert(e.data);
        }, false);

        // !! importnat: call start before post message
        worker.port.start();

        // post a message to the shared web worker
        worker.port.postMessage({ msg: "Html5Fest" });

    </pre>
</section>

<section>
    <h3 class="color1">Shared Web Worker ( sharedWorker.js )</h3>

    <pre class="brush: javascript;  highlight: [6, 8, 9, 13, 19]">
        // count active connections
        var connections = 0;

        // Instead of a single message processing function,
        // the code here attaches multiple event listeners
        self.addEventListener("connect", function (e) {

            // On each connection the port is always the first (and only) port in the event ports list
            var port = e.ports[0];
            connections++;

            // message listener
            port.addEventListener("message", function (e) {
                port.postMessage("Message: " + JSON.stringify(e.data) + ",
                    (Port #" + connections + ")");
            }, false);

            // "Open" the port for communication
            port.start();
        }, false);
    </pre>
    <br/>
    <span class="important">
        Shared Workers can communicate between browser windows or tabs using the
        <span class="highlight">window.postMessage()</span>
    </span>
    <br/>

</section>

<section>
    <h3 class="centered">
        <a href="DemoFiles/workers_shared.html" target="_blank">Demo: Shared Web Worker</a>
    </h3>
</section>

<section>
    <h1 class="color2 centered">
         <img src="images/fileAPI_128.png" align="absmiddle"> File API
    </h1>
</section>

<section>
    <h3 class="fileAPI">File API features</h3>
    <ul>
        <li>Import from the filesystem or the web.</li>
        <li>Create new files from scratch.</li>
        <li>Manipulate existing file data.</li>
        <li>Store file data on the client.</li>
        <li>Publish files back to the web.</li>
    </ul>
</section>
<section>
    <h3>Local files</h3>

    <p>
        The File API specification provides a standard way to interact with local files.
    </p>
    <br/>
    <h4>API:</h4>

    <p>
        <span class="code">File</span> - an individual file; <br/>
        <span class="code">FileList</span> - an array-like sequence of File objects.<br/>
        <span class="code">Blob</span> - Allows for slicing a file into byte ranges.<br/>
    </p>
    <br/>
    <h4>Additional features</h4>

    <p>
        <span class="code">FileReader</span> - used to asynchronously read a file (event handling)<br/>
        <span class="code">Drag And Drop</span> - build in support for files Drag And Drop<br/>
    </p>
</section>

<section>
    <h3>Reading local files</h3>

    <pre class="brush: html">
        <input type="file" id="..." name="..." multiple webkitdirectory/>
    </pre>
    <br/>
    <pre class="brush: javascript">
        // Add the event listener to the input type="file"
        document.getElementById('...').addEventListener('change',
            function( e){

                // FileList object. list of the selected files
                var files = e.target.files;

                // files is a FileList of File objects. List some properties.
                var output = [];

                // Extract the information we can from the files/folder
                for (var i = 0, f; f = files[i]; i++) {
                    // f.name
                    // f.type
                    // f.size
                    // f.lastModifiedDate.toLocaleDateString()
                }
                ...
            }
        }, false);

    </pre>

</section>

<section>
    <h3>Local files (Drag and drop)</h3>

    <output id="list1" class="small"></output>
    <div id="drop_zone">Drop files here</div>

    <script>
        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            var files = evt.dataTransfer.files; // FileList object.

            // files is a FileList of File objects. List some properties.
            var output = [];
            for (var i = 0, f; f = files[i]; i++) {
                output.push('<li><strong>', f.name, '</strong> (', f.type || 'n/a', ') - ',
                        f.size, ' bytes, last modified: ',
                        f.lastModifiedDate.toLocaleDateString(), '</li>');
            }
            document.querySelector('#list1').innerHTML = '<ul>' + output.join('') + '</ul>';
        }

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
        }

        // Setup the dnd listeners.
        var dropZone = document.getElementById('drop_zone');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
    </script>
</section>

<section>
    <h3><a href="DemoFiles/filesDemo1.html">Demo: Read MP3 info</a></h3>

    <h3><a href="DemoFiles/filesDemo2.html">Demo: Read and play MP3 file </a></h3>

    <h3>Data URL: <a
            href="data:text/html,<textarea style='font:20pt Courier;outline:none;padding:10px;height:50%;width:100%;border:1px solid #ccc;border-radius:5px' placeholder='Add code here...'></textarea>">Open
        inline html document</a></h3>
</section>

<section>
    <h1 class="color2">File System API</h1>
</section>

<section>
    <h3>File System API</h3>

    <h2>Opening the file system</h2>
    <pre class="brush: javascript;">
        window.requestFileSystem(
          TEMPORARY,        // persistent vs. temporary storage
          1024 * 1024,      // size (bytes) of needed space
          initFs,           // success callback
          opt_errorHandler  // opt. error callback, denial of access
        );
    </pre>
</section>

<section>
    <h3>File System API</h3>

    <h2>Fetching a file by name</h2>
    <pre class="brush: javascript;">
        function initFs(fs) {

          fs.root.getFile('logFile.txt', {create: true}, function(fileEntry) {

            // fileEntry.isFile == true
            // fileEntry.name == 'logFile.txt'
            // fileEntry.fullPath == '/logFile.txt'

            // Get a File obj
            fileEntry.file(function(file) { ... }, errorHandler);

            // fileEntry.remove(function() {}, errorHandler);
            // fileEntry.moveTo(...);
            // fileEntry.copyTo(...);
            // fileEntry.getParent(function(dirEntry) {}, errorHandler);

          }, errorHandler);

        }
    </pre>
</section>
<section>
    <h3>File System API</h3>

    <h2>File System URLs ( filesystem: )</h2>
    <pre class="brush: javascript;">
        var img = document.createElement('img');

        // filesystem:http://example.com/temporary/myfile.png
        img.src = fileEntry.toURL();
        document.body.appendChild(img);

        // Retrieve a file by its filesystem URL:
        window.resolveLocalFileSystemURL(img.src, function(fileEntry) { ... });
        </pre>
</section>

<section>
    <h3><a href="http://www.htmlfivewow.com/demos/terminal/terminal.html" target="_blank">File system API Demo</a>
    </h3>

</section>
</div>

<script src="js/slideshow.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/workersUtil.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();</script>


</body>
</html>
